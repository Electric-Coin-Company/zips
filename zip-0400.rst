::

  ZIP: 400
  Title: Format of Zcash wallet.dat files
  Author: Duke Leto <duke@leto.net>
  Category: XXX
  Created: 2018-12-15
  License: MIT

Terminology
===========

The key words "MUST", "MUST NOT", and "MAY" in this document are to be interpreted as described in RFC 2119.
[#RFC2119]_

Abstract
===========

This is a Standards ZIP describing the format of Zcash wallet.dat files.

Motivation
===========

"We need to understand the current wallet format in order to design a new format." -- Daira
    https://github.com/zcash/zcash/issues/2312

Specification
===============

Zcash wallet.dat format is inherited from Bitcoin 0.11 wallet format with
various additions to store data related to Sprout and Sapling shielded
addresses, and transactions involving them. Transparent addresses and
transactions involving them are identical, with exceptions being mentioned in
this document.

The wallet.dat is a BerkeleyDB BTree (binary tree) binary file, where all
contents MUST be in a subtree called "main". Zcash nodes MUST NOT store
any data outside of the "main" subtree to maintain backward compatibility
with software meant to work on Bitcoin wallets.

The binary tree has keys and values. The keys consist of multiple units of
data, a length, a type and an actual key value, in that order. For example, an
entry for the pubkey of a transparent address MUST have type "key", and length
MUST correspond to the length of the string "key", i.e. 3. This number is
stored as an `unsigned char`.

The rest of the data in the BTree key is actual public key data. The value of
each key stores the private key associated with that pubkey and the SHA256 of
the public and private key concatenated together.

Similarly, there is a "zkey" type which stored data related to Sprout shielded
addresses. This key type simply stores a public and private key, without a
hash of the values. This means that these entries take up much less space
than transparent keys.

The reader should note that Zcash addresses of any kind never appear in a
wallet.dat file. Only public keys and private keys exist in wallet.dat files,
addresses never appear or are stored in any way, they are calculated from
pubkeys by nodes when the wallet is loaded.

Here is a concise list of each wallet key type with the kind of data that is stored:

  * bestblock         - Data relating to best block, i.e. chaintip
  * chdseed           - Encrypted HD seed
  * cscript           - Redeem script
  * defaultkey        - Default transparent address pubkey
  * hdseed            - Hierarchical Deterministic seed
  * hdchain           - Hierarchical Deterministic chain code, derived from seed
  * key               - Transparent pubkey and privkey, with sha256(pubkey+privkey)
  * keymeta           - Transparent key metadata
  * minversion        - Minimum wallet version required to open this wallet.dat
  * mkey              - Master key
  * name
  * orderposnext      - Index of next tx
  * pool              - Keypool pub/private keypair
  * purpose           - Purpose of a transparent address
  * sapzaddr          - Sapling zaddr viewing key
  * sapzkey           - Sapling zaddr pubkey and privkey
  * sapzkeymeta       - Metadata about Sapling pubkeys
  * tx                - Transaction data
  * vkey              - Sprout viewing key
  * version
  * watchs            - Watch-only address
  * witnesscachesize  - Shielded Note Witness cache size
  * zkey              - Sprout zaddr pubkey and privkey
  * zkeymeta          - Metadata about Sprout pubkey

The key types beginning with z* and sapz* are Zcash additions to the
Bitcoin wallet format, they do not exist in Bitcoin Core wallets.

The following keys only exist in Zcash Sapling-enabled wallets:
  * sapzkey
  * sapzaddr
  * sapzkeymeta

A full description of each key type and the values they store is below.

bestblock
=========

  * There MUST be only one `bestblock` key per wallet.
  * Size: Variable

cscript
=======

defaultkey
==========

  * Default transparent public key of the wallet.
  * There MUST be only one `defaultkey` key per wallet.
  * The pubkey value of this key MUST exist in the current wallet as a
    public, private key pair, stored in an element of type `key`.
  * Value: Hex string, high nybble first.

hdseed
======
  * Size: 33 bytes

hdchain
======
  * Size: 48 bytes

key
===

This stores a (public,private) keypair for a transparent address, along with
SHA256(public+private), where `+` means concatention.

keymeta
======

This stores metadata about a transparent key. If no metadata is available, the
unix timestamp of when this key was created is stored.

  * Size: 12 bytes

mkey
====

Master key for an encrypted wallet.

minversion
===========
  * Size: 4 bytes

name
===========

orderposnext
===========

This stores the next valid index to be used in the array of transactions,
which is also equal to the number of transactions stored in the wallet.

  * There MUST be only one `orderposnext` key per wallet.
  * Size: 8 bytes

pool
===========
  * Size: 46 bytes

purpose
===========
  * Size: 8 bytes

sapzaddr
=========

sapzkey
===========
  * Size: 169 bytes

sapzkeymeta
===========
  * Size: 58 bytes

tx
===========
  * Size: Variable

version
=======

  * There MUST be only one `version` key per wallet.
  * Value: unsigned integer
  * Size: 4 bytes

vkey
=====

Sprout viewing key.

watchs
======

A watch only transparent address.

witnesscachesize
================
  * Size: 8 bytes

zkey
================

Sprout shielded address public key and private key.

zkeymeta
================

Sprout key metadata.

References
==========

.. [#RFC2119] `Key words for use in RFCs to Indicate Requirement Levels <https://tools.ietf.org/html/rfc2119>`_
